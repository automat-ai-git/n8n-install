# WSL2 Monitoring Override
#
# This file overrides node-exporter and cAdvisor configuration for WSL2 environments.
# It is NOT loaded by default. To enable, set WSL2_MODE=true in your .env file.
#
# WHY THIS IS NEEDED:
#   Both node-exporter and cAdvisor are written in Go and traverse mounted filesystems
#   to collect disk metrics. In WSL2, this includes Windows drives (/mnt/c, /mnt/d, ...)
#   mounted via the 9p/drvfs protocol. stat() calls on these paths hang indefinitely.
#   Because Go services collect on a fixed interval without cancelling timed-out goroutines,
#   each scrape cycle spawns new blocked goroutines — resulting in load average >900
#   and a frozen SSH session within seconds of starting the monitoring stack.
#
# DO NOT apply this override on native Linux servers — it disables disk metrics.

services:
  node-exporter:
    command:
      - "--path.procfs=/host/proc"
      - "--path.sysfs=/host/sys"
      # Exclude Windows-mounted drives (/mnt/c, /mnt/d, etc.) and WSL-internal paths
      - "--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc|mnt|usr/lib/wsl)($$|/)"
      # Exclude 9p and drvfs filesystem types used by WSL2 for Windows drive passthrough
      - "--collector.filesystem.fs-types-exclude=^(autofs|binfmt_misc|bpf|cgroup2?|configfs|debugfs|devpts|devtmpfs|fusectl|hugetlbfs|iso9660|mqueue|nsfs|overlay|proc|procfs|pstore|rpc_pipefs|securityfs|selinuxfs|squashfs|sysfs|tracefs|9p|drvfs)$$"

  cadvisor:
    command:
      # Disable disk/diskIO metrics to prevent rootfs traversal into /mnt/* Windows paths
      - "--disable_metrics=disk,diskIO,resctrl,tcp,udp,percpu,sched,process"
      # Only monitor Docker containers, not all host processes
      - "--docker_only=true"
