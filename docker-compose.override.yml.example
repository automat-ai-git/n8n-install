# =============================================================================
# docker-compose.override.yml — Local customizations (gitignored)
# =============================================================================
# This file is automatically loaded by Docker Compose alongside docker-compose.yml.
# It is listed in .gitignore, so your local changes will NOT be overwritten by updates.
#
# Use this file to override any service settings for your local environment.
#
# -----------------------------------------------------------------------------
# WSL2 FIX: Monitoring stack (node-exporter + cAdvisor) on WSL2
# -----------------------------------------------------------------------------
# SYMPTOM: After enabling the "monitoring" profile on WSL2, load average spikes
# above 900 and the SSH session freezes within seconds.
#
# ROOT CAUSE: Both node-exporter and cAdvisor are written in Go and traverse
# mounted filesystems to collect disk metrics. In WSL2 this includes Windows
# drives (/mnt/c, /mnt/d, ...) via the 9p/drvfs protocol. stat() calls on
# these paths hang indefinitely. Because Go collects metrics on a fixed interval
# without cancelling timed-out goroutines, each scrape spawns new blocked
# goroutines — resulting in load average >900 and a frozen SSH session.
#
# FIX: Uncomment the block below to apply WSL2-safe flags.
# This restricts both services from scanning Windows-mounted drives.
# DO NOT enable on native Linux servers — it disables disk metrics.
#
services:
   appsmith:
     healthcheck:
       test: ["CMD-SHELL", "http_proxy= https_proxy= HTTP_PROXY= HTTPS_PROXY= curl -f -s http://localhost/api/v1/health || exit 1"]

   comfyui:
     healthcheck:
       test: ["CMD-SHELL", "curl -f -s http://localhost:8188 > /dev/null || exit 1"]

   paddleocr:
     healthcheck:
       test: ["CMD-SHELL", "curl -f -s http://localhost:8080 > /dev/null || exit 1"]
       start_period: 300s

   lightrag:
     healthcheck:
       test: ["CMD-SHELL", "http_proxy= https_proxy= HTTP_PROXY= HTTPS_PROXY= curl -f -s http://localhost:9621/health > /dev/null || exit 1"]
       start_period: 120s

   node-exporter:
     init: true
     deploy:
       resources:
         limits:
           pids: 100
     command:
       - "--path.procfs=/host/proc"
       - "--path.sysfs=/host/sys"
       - "--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc|mnt|run|init|usr/lib/wsl)($|/)"
       - "--collector.filesystem.fs-types-exclude=^(autofs|binfmt_misc|bpf|cgroup2?|configfs|debugfs|devpts|devtmpfs|fusectl|hugetlbfs|iso9660|mqueue|nsfs|overlay|proc|procfs|pstore|rpc_pipefs|securityfs|selinuxfs|squashfs|sysfs|tracefs|9p|drvfs|tmpfs|rootfs)$"
       # Disable collectors that hang in WSL2 due to missing/broken netlink support
       - "--no-collector.arp"
       - "--no-collector.conntrack"
       - "--no-collector.wifi"

   cadvisor:
     command:
       - "--disable_metrics=disk,diskIO,resctrl,tcp,udp,percpu,sched,process"
       - "--docker_only=true"
       # Reduce polling frequency (default 1s is too aggressive for WSL2)
       - "--housekeeping_interval=30s"
       # Skip root cgroup stats (can take 3-8s to read in WSL2)
       - "--disable_root_cgroup_stats=true"oup_stats=true"